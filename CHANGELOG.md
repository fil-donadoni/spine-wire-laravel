# Changelog

All notable changes to this project will be documented in this file.

The format is based on [Keep a Changelog](https://keepachangelog.com/en/1.0.0/),
and this project adheres to [Semantic Versioning](https://semver.org/spec/v2.0.0.html).

## [3.0.0] - 2025-01-19

### Changed - Major Architecture Refactor

**This package has been split into two projects:**

| Component | Responsibility |
|-----------|----------------|
| **Spine Wire Laravel** (this package) | Docker, cloudbuild.yaml, health check, logging |
| **[Spine Core](https://github.com/fil-donadoni/spine-core)** | Terraform infrastructure, base image builds, configuration UI |

### Removed
- All Terraform modules and configuration (`stubs/terraform/`)
- Terraform-related scripts (`build-base-image.sh`, `deploy.sh`, `create-secrets.sh`, etc.)
- Terraform documentation files
- `INSTALLATION.md` and `EXAMPLES.md` (obsolete documentation)

### What This Package Now Provides
- Docker configuration (Dockerfile, Dockerfile.base template, entrypoints)
- Cloud Build CI/CD configuration (cloudbuild.yaml)
- Health check controller and service
- Google Cloud Logging integration

### Migration from v2.x
If you were using v2.x with integrated Terraform:

1. Install [Spine Core](https://github.com/fil-donadoni/spine-core) for infrastructure management
2. Move your `terraform.tfvars` configuration to Spine Core
3. Use Spine Core to build and push base images
4. Continue using Spine Wire for deployment files in your Laravel project

---

> **Note:** Versions below (2.x and earlier) included integrated Terraform support which has been moved to Spine Core.

---

## [2.1.2] - 2025-12-10

### Fixed
- **CRITICAL: Fixed database password mismatch** - Terraform was generating random passwords instead of using Neon-generated passwords
  - Removed `random_password` resource from neon-database module
  - Now using `neon_role.password` attribute (automatically generated by Neon)
  - Database connection strings now contain correct passwords
  - Fixes Cloud Build health check failures (`connection is insecure` errors)
  - Existing deployments need to run `terraform apply` to update secrets with correct passwords
- **Fixed invalid Cloud Build configuration** - Removed unsupported GitHub App private key authentication
  - Cloud Build v2 API only supports OAuth token authentication (`oauth_token_secret_version`)
  - Simplified GitHub authentication to use PAT (Personal Access Token) only
  - Removed obsolete `github_app_private_key_secret_name` variable and related logic
  - Deleted obsolete `setup-github-app.sh` script (no longer needed)

### Changed
- Removed `hashicorp/random` provider from neon-database module (no longer needed)
- Simplified Cloud Build configuration to support only PAT authentication
- **Optimized Cloud Build deployment performance** - Service and Jobs now deploy in parallel
  - Added `waitFor: ["build-and-push"]` to both `update_service` and `update_jobs` steps
  - Both steps now execute simultaneously after Docker image build completes
  - Reduces total deployment time by running independent updates concurrently

### Migration Notes
If you're experiencing database connection issues with existing deployments:

```bash
cd terraform

# Apply the fix to update secrets with correct Neon passwords
terraform apply -target='module.neon_database["your-app"].google_secret_manager_secret_version.db_password["production"]' \
                -target='module.neon_database["your-app"].google_secret_manager_secret_version.db_connection_string["production"]'

# Trigger new Cloud Build to use updated secrets
gcloud builds submit --config=../cloudbuild.yaml ..
```

---

## [2.1.1] - 2025-12-07

### Fixed
- **CRITICAL: Fixed Neon project recreation issue** - Terraform was attempting to destroy and recreate existing Neon projects
  - Added `organization_id` optional variable to Neon module
  - Added `ignore_changes = [org_id]` lifecycle rule to prevent recreation when org_id changes
  - Existing Neon projects now stay stable across Terraform runs
  - No data loss risk anymore when running `terraform plan/apply`

### Changed
- **Simplified Neon API key management** - More flexible authentication options
  - API key can now be provided via environment variable: `TF_VAR_neon_api_key` or `NEON_API_KEY`
  - Alternatively, can be stored in GCP Secret Manager as `neon-api-key` (simplified name)
  - Old secret name `{client}-{app}-neon-api-key` no longer used
  - Priority: 1) Environment variable, 2) Secret Manager
  - Reduces coupling between Terraform and specific naming conventions

### Migration Notes
If you have an existing Neon API key secret with the old naming pattern:
```bash
# Option 1: Create new simplified secret (recommended)
gcloud secrets versions access latest --secret=old-name-neon-api-key | \
  gcloud secrets create neon-api-key --data-file=-

# Option 2: Use environment variable
export TF_VAR_neon_api_key=$(gcloud secrets versions access latest --secret=old-name-neon-api-key)
terraform plan
```

---

## [2.1.0] - 2025-12-07

### Added
- **`--keep-tfvars` flag**: Preserve existing `terraform.tfvars` during setup iterations
  - Automatically detects if template structure changed (new/removed variables)
  - Saves new template as `terraform.tfvars.new` for manual merge
  - Shows clear warning and diff instructions when template changed
- **Smart CLI parameter handling**: Skip interactive prompts when parameters provided via CLI
  - When using `--project-id=value`, shows confirmation instead of prompting
  - Significantly improves automation and scripting experience
  - All config flags now properly bypass interactive input
- **Development workflow optimization** with composer path repository
  - Documented in CLAUDE.md with complete setup instructions
  - Reduces iteration time from 3-5 minutes to 5-10 seconds
  - Zero risk of losing customized terraform.tfvars

### Changed
- Setup command now shows `âœ“ Parameter: value` confirmation for CLI-provided parameters
- Interactive prompts only shown for parameters not provided via CLI

### Developer Experience
- **95% reduction** in development iteration time
- **Zero git push/composer update** needed during development
- Automatic validation and warning system for terraform.tfvars template changes

---

## [2.0.0] - 2025-12-05

### BREAKING CHANGES

This is a major refactor that **simplifies the Neon database configuration** and removes confusing flags.

**Migration Guide:**

If you're upgrading from v1.x, update your `terraform.tfvars`:

**OLD (v1.x):**
```hcl
neon = {
  project_id        = "gentle-lake-12345"
  exists            = true
  secrets_exist     = true
  region            = "aws-eu-central-1"
  database_host     = "ep-xxx.neon.tech"
  default_branch_id = "main"
}
```

**NEW (v2.0.0):**
```hcl
neon = {
  region = "aws-eu-central-1"
}
```

That's it! Terraform will manage everything automatically from the state.

### Removed

- **Removed confusing `exists` flag** - The Neon project is now ALWAYS managed by Terraform
- **Removed `secrets_exist` flag** - GCP secrets are now ALWAYS managed by Terraform
- **Removed `project_id`, `database_host`, `default_branch_id` parameters** - These are read from Terraform state
- **Removed complex validation logic** that caused confusion about when to use `true` vs `false`

### Changed

- **Simplified Neon configuration** to only require `region` parameter
- **Terraform now always creates and manages** the Neon project and secrets
- **Existing projects can be imported** using `terraform import` command
- **Updated all documentation** (README, INSTALLATION, EXAMPLES) to reflect simplified workflow

### Fixed

- Fixed issue where `exists = true` would cause Terraform to try destroying managed resources
- Fixed confusing validation errors about project_exists vs provided parameters
- Improved clarity on when Terraform manages resources vs when they're external

### Documentation

- Updated INSTALLATION.md with simplified Neon configuration
- Updated EXAMPLES.md with cleaner configuration examples
- Added import instructions for existing Neon projects
- Removed all references to deprecated flags

---

## [1.0.0] - 2024-12-04

### Added

#### Infrastructure
- Complete Terraform infrastructure for GCP Cloud Run deployment
- Three reusable Terraform modules:
  - `gcp-project`: Project-level resources (APIs, service accounts, IAM, Artifact Registry)
  - `laravel-app`: Cloud Run services (web, queue workers, scheduled jobs)
  - `neon-database`: Neon serverless PostgreSQL provisioning
- Remote Terraform state management with GCS backend
- Automated deployment script (`deploy.sh`) with validation and error handling
- Helper scripts for:
  - Secret creation and management (`create-secrets.sh`)
  - Service account import (`import-service-accounts.sh`)
  - Secret import from existing projects (`import-secrets.sh`)
  - Service account verification (`check-service-accounts.sh`)
- Terraform helper library (`terraform-helpers.sh`) with common functions
- GCP checks library (`gcp-checks.sh`) for authentication and permissions validation

#### Docker
- Multi-stage Dockerfile with FrankenPHP + Laravel Octane
- Optimized for Cloud Run deployment with health checks
- Three specialized entrypoint scripts:
  - `service-entrypoint.sh`: Web service with Octane
  - `queue-entrypoint.sh`: Queue worker service
  - `job-entrypoint.sh`: Scheduled job execution
- Custom PHP configuration (`php.ini`) optimized for production
- `.dockerignore` for optimized build context

#### CI/CD
- Cloud Build configuration (`cloudbuild.yaml`) for automated deployments
- Multi-stage build process:
  - Dependency installation
  - Asset compilation
  - Docker image build and push
  - Cloud Run deployment
- GitHub Actions examples:
  - Terraform deployment workflow
  - Cloud Build trigger via GitHub

#### Laravel Integration
- `DevOpsServiceProvider`: Auto-discovered Laravel service provider
- `SetupDevOpsCommand`: Interactive Artisan command (`php artisan devops:setup`)
  - Interactive prompts for GCP configuration
  - Automatic file copying from stubs to project
  - Placeholder replacement in template files
  - Configuration summary and confirmation
  - Support for non-interactive mode via CLI options
  - `--force` flag to overwrite existing files
- Config file (`config/devops.php`) with sensible defaults
- Publishable configuration

#### Feature Flags
- Configurable Cloud Storage buckets (optional)
- Configurable Pub/Sub topics and subscriptions (optional)
- Configurable queue worker service (optional)
- Configurable scheduled jobs with Cloud Scheduler (optional)
- Configurable custom domain mapping with SSL (optional)

#### Documentation
- Comprehensive README.md with feature overview
- Detailed INSTALLATION.md guide with:
  - Prerequisites and setup instructions
  - Step-by-step deployment guide
  - Troubleshooting section
  - Best practices
- EXAMPLES.md with real-world configurations:
  - Minimal configuration
  - Full-featured setup
  - Multi-environment deployment
  - Custom domain configuration
  - Pub/Sub integration
  - Scheduled jobs
  - High-traffic optimization
  - Development environment
- 27 infrastructure documentation files in `terraform/docs/`:
  - Architecture overview
  - Module documentation
  - Deployment guides
  - Security best practices
  - Cost optimization tips
  - Troubleshooting guides
  - Feature-specific guides

#### Developer Experience
- Clear variable naming and documentation
- Example terraform.tfvars with all options
- Consistent resource naming conventions
- Comprehensive outputs for integration
- Git-friendly (all secrets via Secret Manager)
- Deployment orchestration script (deploy.sh)

### Infrastructure Features

#### GCP Services
- Cloud Run for serverless container deployment
- Artifact Registry for Docker image storage
- Secret Manager for secure credential management
- Cloud Storage for file uploads (optional)
- Cloud Pub/Sub for async messaging (optional)
- Cloud Scheduler for cron jobs (optional)
- Cloud Build for CI/CD automation
- IAM service accounts with least-privilege permissions

#### Database
- Neon serverless PostgreSQL integration
- Database branching support for environments
- Automatic connection string management
- Secure credential storage in Secret Manager

#### Networking & Security
- HTTPS-only with automatic SSL certificates
- Custom domain mapping support
- IAM-based access control
- Secret rotation support
- VPC-ready architecture (extensible)

#### Scalability
- Autoscaling from 0 to configurable max instances
- Configurable CPU and memory per service
- Configurable concurrency limits
- Independent scaling for web and queue workers
- Multi-region support (via configuration)

### Requirements
- PHP: ^8.2
- Laravel: ^11.0 or ^12.0
- Terraform: ^1.5.0
- GCP account with billing enabled
- Neon account (free tier available)

### Breaking Changes
None (initial release)

### Deprecations
None (initial release)

### Security
- All secrets stored in GCP Secret Manager
- No hardcoded credentials
- Service accounts with minimal required permissions
- Secure environment variable injection
- HTTPS enforcement

### Known Issues
None

---

## Future Releases

### [1.1.0] - Planned

#### Added
- Cloud SQL support as alternative to Neon
- Redis cluster configuration templates
- Enhanced monitoring dashboard templates
- Alerting policy examples
- Cost tracking and budgeting templates
- Backup automation scripts

#### Changed
- Improved setup wizard with more validation
- Enhanced error messages in deployment scripts
- Better default configurations based on app size

### [1.2.0] - Planned

#### Added
- Multi-region deployment support
- Global load balancing configuration
- CDN integration templates
- Cloud Armor (WAF) configuration examples
- VPC Service Controls setup

#### Changed
- Terraform module refactoring for better reusability
- Improved documentation with video tutorials

### [2.0.0] - Planned

#### Added
- Kubernetes (GKE) deployment option
- Helm charts for Kubernetes deployment
- Service mesh integration (Istio/Anthos)
- Advanced monitoring with Prometheus/Grafana

#### Changed
- **BREAKING**: Terraform 1.7+ required
- **BREAKING**: Restructured module interfaces
- **BREAKING**: New variable naming conventions
- Refactored for GCP best practices 2025

#### Removed
- **BREAKING**: Deprecated legacy configuration format

---

## Version History Summary

| Version | Release Date | Status | Major Features |
|---------|-------------|--------|----------------|
| 1.0.0   | 2024-12-04  | âœ… Released | Initial release with full GCP Cloud Run support |
| 1.1.0   | TBD         | ðŸ“‹ Planned | Cloud SQL, Redis, Monitoring enhancements |
| 1.2.0   | TBD         | ðŸ“‹ Planned | Multi-region, CDN, Cloud Armor |
| 2.0.0   | TBD         | ðŸ’¡ Future | Kubernetes, Breaking changes |

---

## Migration Guides

### Migrating from Manual Infrastructure

If you have existing GCP infrastructure deployed manually:

1. **Backup everything**: State files, configurations, database
2. **Import existing resources**: Use `terraform import` for resources you want to keep
3. **Review the plan**: Carefully check `terraform plan` output
4. **Test in staging first**: Never migrate production directly
5. **See INSTALLATION.md**: Detailed migration section available

### Version Upgrade Guides

#### Upgrading to 1.x from pre-release
Not applicable (initial release)

Future upgrade guides will be added here.

---

## Support

For questions, issues, or feature requests:
- GitHub Issues: https://github.com/fil-donadoni/spine-wire-laravel/issues

## Contributing

Contributions are welcome! Please feel free to submit a Pull Request.

## License

MIT License - see LICENSE file for details

---

[Unreleased]: https://github.com/fil-donadoni/spine-wire-laravel/compare/v1.0.0...HEAD
[1.0.0]: https://github.com/fil-donadoni/spine-wire-laravel/releases/tag/v1.0.0
